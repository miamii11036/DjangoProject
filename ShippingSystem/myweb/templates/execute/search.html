{% extends "base.html" %}
{% load static %}
{% block title %}Search{% endblock %}

{% block head %}
    <!--載入jquery函數庫-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <style>
        body{
            height: 100vh;   
        }
        .btn-outline-secondary{
            --bs-btn-color: #46656F;
            --bs-btn-border-color: #46656F;
            --bs-btn-hover-color: #FBFBFB;
            --bs-btn-hover-bg: #46656F;
            --bs-btn-hover-border-color:--bs-btn-hover-border-color: #46656F;
            --bs-btn-active-color: #FBFBFB;
            --bs-btn-active-bg: #46656F;
            --bs-btn-active-border-color: #46656F;
            --bs-btn-disabled-color: #46656F;
            --bs-btn-disabled-border-color: #46656F;
        }
        #submit{
             /* 按鈕與輸入框的間距 */
            padding: 5px 5px;
            background-color: #46656F; /* 按鈕背景色 */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            width: fit-content; 
        }
        @media (max-width: 700px) { 
            .responsive-form { 
                flex-direction: column; 
            } 
        }

        .border.border-2.shadow.p-3.mb-5.bg-body-tertiary.rounded {
            flex: 1; 
            margin-top: 50px; 
            min-width: 700px; 
            margin: auto;
        }
        #OrderIDSearch {
            max-width: 1450px; 
            margin-top: 50px;
            margin-bottom: 20px !important;
        }
        .input-group.mb-3 {
            margin-bottom: 0px !important;
        }
        #column1 {
            min-width: 100px;
            text-align: left;
            word-wrap: break-word;
        }
    </style>
{% endblock %}
<!-------body-----想法:使用者輸入orderId後，系統會自動在表格中搜尋對應的ID，找到後該列會反藍並展開order的詳細內容---------
----------------------提供篩選條件，讓使用者篩選出特定範圍內的訂單清單------搜尋ID可以用相機掃描QRCODE-------------------------------->

{% block content %}
<!--查詢orderID輸入框-->
<div class="border border-2 shadow p-3 mb-5 bg-body-tertiary rounded" id="OrderIDSearch">
    <form action="" method="post" class="hstack gap-3"> 
        <div class="input-group mb-3" style="margin-bottom: 0px !important;">
            <div class="input-group-text" id="OrderID">Order ID</div>
            <input type="text" class="form-control" id="order_id" name="order_id" aria-label="OrderID" >
        </div>
        <!--查詢按鈕-->
        <button class="btn btn-outline-secondary" type="button" id="OrderIDSearchButton">Search</button> 
    </form>
</div>
<!--篩選範圍設定框-->
<div class="border border-2 shadow p-3 mb-5 bg-body-tertiary rounded"  style="max-width: 1450px;">
    <form>
        <div class="hstack gap-3">
            <!--年份-->
            <div class="input-group mb-3">
                <span class="input-group-text" id="Year">Year</span>
                <input type="text" class="form-control" id="year" name="year">
            </div>
            <!--月份-->
            <div class="input-group mb-3">
                <span class="input-group-text"  id="Month">Month</span>
                <select class="form-select" name="month">
                    <option selected value="1">January(1)</option>
                    <option value="2">February(2)</option>
                    <option value="3">March(3)</option>
                    <option value="4">April(4)</option>
                    <option value="5">May(5)</option>
                    <option value="6">June(6)</option>
                    <option value="7">July(7)</option>
                    <option value="8">August(8)</option>
                    <option value="9">September(9)</option>
                    <option value="10">October(10)</option>
                    <option value="11">November(11)</option>
                    <option value="12">December(12)</option>
                </select>
            </div>
            <!--地區-->
            <div class="input-group mb-3">
                <span class="input-group-text" id="Region">Region</span>
                <input type="text" class="form-control" name="region">
            </div>
            <!--提交按鈕與重置按鈕-->
            <div class="hstack gap-3">
                <button class="btn btn-outline-secondary" type="button" id="FilterSearch">Search</button> 
                <div class="vr"></div>
                <button  type="button" class="btn btn-outline-secondary">Reset</button>
            </div>
        </div>
    </form>
</div>

<!--訂單列表-->
<div class="border border-2 shadow p-3 mb-5 bg-body-tertiary rounded"  style="max-width: 2100px;">
    <table class="table table-striped">
        <thead class="table-light">
            <th id = "column1">Order ID</th>
            <th id = "column1">Year</th>
            <th id = "column1">Month</th>
            <th id = "column1">Region</th>
            <th id = "column1">Client</th>
            <th id = "column1" style="min-width: 70px;">Status</th>
            <th id = "column1"></th>
        </thead>
        <tbody> 
            {% for order in orders %}
            <!--填入每一張訂單-->
            <tr class="order-list" data-order-id="{{order.order_id}}">
                                <!--data-order-id為自定義屬性，使用data-*屬性可以在script區域中使用data()來取得該屬性的值-->
                <td>{{order.order_id}}</td>
                <td>{{order.year}}</td>
                <td>{{order.month}}</td>
                <td>{{order.region}}</td>
                <td>{{order.client}}</td>
                <td>{{order.status}}</td>
                <td style="max-width: fit-content; padding-top: 8px; padding-left: 0px;">
                    <button class="expand-btn" id="submit">Expand/Hide</button>
                </td>
            </tr>
            <!--設定訂單的詳細內容品項表格-->
            <tr class="order-detail" id="order-detail-{{order.order_id}}" >
                <td colspan="7"> <!--合併一列的儲存格，與order-list表格做出區別，因為兩個table的column數量不一樣-->
                    <!--開始填入order-detail的內容-->
                    <table class="table table-striped">
                        <thead class="table-light">
                            <th>Product ID</th>
                            <th>Product name</th>
                            <th>Quantity</th>
                            <th>Package</th>
                        </thead>
                        <tbody class="order-detail-data"><!--Json傳遞過來的資料開始填入-->
                            
                        </tbody>
                    </table>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>



<script>
/*document.addEventListener("DOMContentLoaded", function () {
    // 選取所有的 Expand/Hide 按鈕
    const expandButtons = document.querySelectorAll(".expand-btn");

    expandButtons.forEach(button => {
        button.addEventListener("click", function () {
            // 找到按鈕所在的父層 <tr>
            const orderRow = this.closest("tr");
            // 取得對應的詳細內容行 (order-detail)
            const orderId = orderRow.dataset.orderId;
            const detailRow = document.querySelector(`#order-detail-${orderId}`);

            if (detailRow) {
                // 切換 display 屬性
                if (detailRow.style.display === "none" || detailRow.style.display === "") {
                    detailRow.style.display = "table-row"; // 顯示
                } else {
                    detailRow.style.display = "none"; // 隱藏
                }
            }
        });
    });
});*/
    
$(document).ready(function () {
    $(document).on("click", ".expand-btn", function () {
        const row = $(this).closest("tr");
        const orderid = row.data("order-id");
        const orderdetail = $(`#order-detail-${orderid}`);

        if (orderdetail.is(":visible")) {
            // 使用者再次點擊按鈕時收起 orderdetail 表格
            orderdetail.hide();
        } else {
            // 如果子表格尚未載入資料，透過 AJAX 請求獲取數據
            if (orderdetail.find(".order-detail-data").children().length === 0) {
                $.get(`/order_detail/${orderid}/`, function (data) {
                    const products = data.orderdetail;
                    const tbody = orderdetail.find(".order-detail-data");

                    tbody.empty();
                    products.forEach(product => {
                        tbody.append(`
                            <tr>
                                <td>${product.product_id}</td>
                                <td>${product.product_name}</td>
                                <td>${product.quantity}</td>
                                <td>${product.package}</td>
                            </tr>
                        `);
                    });
                });
            }
            orderdetail.show();
        }
    });
});
</script>

{% endblock %}
